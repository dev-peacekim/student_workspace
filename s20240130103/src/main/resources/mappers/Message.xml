<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.blackberry.s20240130103.MessageMapper">

	<!-- ================ 전체 유저 리스트 가져오기 ================= -->
	<select id="kdwGetAllUsers"
		resultType="com.blackberry.s20240130103.lhs.model.User">
		SELECT * FROM users
	</select>

	<!-- =========== 각 쪽지함 쪽지 개수 가져오기 ========== -->
	<!-- 받은 쪽지 개수 -->
	<select id="totReceiveMsgCnt" resultType="int"
		parameterType="java.lang.Long">
		SELECT COUNT(*) FROM message
		WHERE msg_receiver = #{msgReceiver}
		AND msg_store_chk = 0
		AND msg_delete_chk = 0
	</select>
	<!-- 보낸 쪽지 개수 -->
	<select id="totSentMsgCnt" resultType="int"
		parameterType="java.lang.Long">
		SELECT COUNT(*) FROM message
		WHERE msg_sender = #{msgSender}
		AND msg_store_chk = 0
		AND msg_delete_chk = 0
	</select>
	<!-- 쪽지보관함 개수 -->
	<select id="totStoredMsgCnt" resultType="int"
		parameterType="java.lang.Long">
		SELECT COUNT(*) FROM message
		WHERE (msg_receiver = #{storeboxUserNo} 
		   OR msg_sender = #{storeboxUserNo})
		AND msg_store_chk = 1
		AND msg_delete_chk = 0
	</select>
	<!-- 휴지통 개수 -->
	<select id="totTrashMsgCnt" resultType="int"
		parameterType="java.lang.Long">
		SELECT COUNT(*) FROM message
		WHERE (msg_receiver =
		#{trashboxUserNo} OR msg_sender = #{trashboxUserNo})
		AND msg_delete_chk = 1
	</select>



	<!-- =========== 각 쪽지함 리스트 가져오기 ========== -->
	<!-- 받은 쪽지 리스트 가져오기 -->
	<select id="kdwReceivedMessagesAll" parameterType="KdwMessage"
		resultType="KdwMessage">
	    <![CDATA[
	    SELECT
	    *
	    FROM
	    (
	        SELECT rownum rn, a.*
	        FROM
	        (select * 
	        from message 
	        WHERE msg_receiver = #{msgReceiver} 
	        AND msg_store_chk = 0 
	        AND msg_delete_chk = 0 
	        order by msg_no DESC) a
	    )
	    WHERE rn >= #{start}
	    and rn <= #{end}
	    ]]>
	</select>
	<!-- 보낸 쪽지 리스트 가져오기 -->
	<select id="kdwSentMessagesAll" parameterType="KdwMessage"
		resultType="KdwMessage">
	    <![CDATA[
	    SELECT
	    *
	    FROM
	    (
	        SELECT rownum rn, a.*
	        FROM
	        (select * 
	        from message 
	        WHERE msg_sender = #{msgSender} 
	        AND msg_store_chk = 0 
	        AND msg_delete_chk = 0 
	        order by msg_no DESC) a
	    )
	    WHERE rn >= #{start}
	    and rn <= #{end}
	    ]]>
	</select>
	<!-- 쪽지 보관함 리스트 가져오기 -->
	<select id="kdwStoredMessagesAll" parameterType="KdwMessage"
		resultType="KdwMessage">
	    <![CDATA[
	    SELECT *
	    FROM (
	        SELECT rownum rn, a.*
	        FROM (
	            SELECT *
	            FROM message
	            WHERE (msg_receiver = #{storeboxUserNo} OR msg_sender = #{storeboxUserNo})
	              AND msg_store_chk = 1
	              AND msg_delete_chk = 0
	            ORDER BY msg_no DESC
	        ) a
	    )
	    WHERE rn >= #{start} AND rn <= #{end}
	    ]]>
	</select>
	<!-- 휴지통 리스트 가져오기 -->
	<select id="kdwTrashMessagesAll" parameterType="KdwMessage"
		resultType="KdwMessage">
	    <![CDATA[
	    SELECT *
	    FROM (
	        SELECT rownum rn, a.*
	        FROM (
	            SELECT *
	            FROM message
	            WHERE (msg_receiver = #{trashboxUserNo} OR msg_sender = #{trashboxUserNo})
	              AND msg_delete_chk = 1
	            ORDER BY msg_no DESC
	        ) a
	    )
	    WHERE rn >= #{start} AND rn <= #{end}
	    ]]>
	</select>


	<!-- =========== 받은쪽지 & 보낸쪽지 정보 읽기 ========== -->
	<!-- 받은 & 보낸 쪽지 정보 -->
	<select id="kdwGetMessageById" parameterType="java.lang.Long"
		resultType="KdwMessage">
		SELECT * FROM message
		WHERE msg_no = #{msgNo}
	</select>
	<!-- 메시지 읽은 시간 업데이트 -->
	<update id="kdwUpdateReadDate" parameterType="java.lang.Long">
		UPDATE message
		SET
		msg_readdate = SYSTIMESTAMP
		WHERE msg_no = #{msgNo}
	</update>

	<!-- 보관 버튼 클릭시 msg_store_chk 업데이트 -->
	<update id="kdwUpdateMsgStoreStatus"
		parameterType="java.util.List">
		UPDATE message
		SET msg_store_chk = 1
		WHERE msg_no IN
		<foreach collection="list" item="msgNo" open="(" separator=","
			close=")">
			#{msgNo}
		</foreach>
	</update>

	<!-- 삭제 버튼 클릭시 msg_delete_chk 업데이트 -->
	<update id="kdwUpdateMsgDeleteStatus"
		parameterType="java.util.List">
		UPDATE message
		SET msg_delete_chk = 1
		WHERE msg_no IN
		<foreach collection="list" item="msgNo" open="(" separator=","
			close=")">
			#{msgNo}
		</foreach>
	</update>

	<!-- 쪽지 영구 삭제 쿼리 구현 -->
	<delete id="kdwPermanentDeleteMessages"
		parameterType="java.util.List">
		DELETE FROM message
		WHERE msg_no IN
		<foreach collection="list" item="msgNo" open="(" separator=","
			close=")">
			#{msgNo}
		</foreach>
	</delete>
	
	
	<!-- !! 쪽지 등록 & 파일 업로드 !! -->
	<!-- 쪽지 등록 -->
	<insert id="kdwSentMsg" parameterType="KdwMessage"
		useGeneratedKeys="true" keyColumn="msg_no" keyProperty="msg_no">
		INSERT INTO
		message (msg_no, msg_title, msg_content, msg_createdate,
		msg_readdate,
		msg_sender, msg_receiver, msg_delete_chk, msg_store_chk)
		VALUES
		(SEQ_MSG.nextval, #{msg_title}, #{msg_content}, SYSDATE, null,
		#{msg_sender}, #{msg_receiver}, 0, 0)
	</insert>

	<!-- 파일 등록 -->
	<insert id="kdwSaveMessageFile" parameterType="KdwMessageFile">
		INSERT INTO
		message_File (msg_no, msg_file_name, msg_file_user_name,
		msg_file_cnt)
		VALUES (
		#{msg_no},
		#{msg_file_name},
		#{msg_file_user_name},
		(SELECT
		NVL(MAX(msg_file_cnt), 0) + 1
		FROM message_File
		WHERE msg_no =
		#{msg_no})
		)
	</insert>



	<!-- !! 검색 기능 !! -->
	<!-- ========== 받은 쪽지함 검색기능 =========== -->
	<!-- 받은 쪽지함 검색된 리스트 조회 -->
	<select id="kdwSearchReceivedMessages" parameterType="KdwMessage" resultType="KdwMessage">
	  <![CDATA[
	  SELECT *
	  FROM (
	      SELECT rownum rn, a.*
	      FROM (
	          SELECT *
	          FROM message
	          WHERE msg_receiver = #{msgReceiver} 
	            AND msg_store_chk = 0
	            AND msg_delete_chk = 0
	            AND (
	                (#{type} = 'sender' AND msg_sender LIKE '%' || #{keyword} || '%')
	                OR
	                (#{type} = 'titleContent' AND (msg_title LIKE '%' || #{keyword} || '%' OR msg_content LIKE '%' || #{keyword} || '%'))
	                OR
	                (#{type} != 'sender' AND #{type} != 'titleContent' AND (
	                    msg_sender LIKE '%' || #{keyword} || '%' OR 
	                    msg_title LIKE '%' || #{keyword} || '%' OR 
	                    msg_content LIKE '%' || #{keyword} || '%'
	                ))
	            )
	      ) a
	      ORDER BY msg_no DESC
	  )
	  WHERE rn >= #{start} AND rn <= #{end}
	  ]]>
	</select>
	<!-- 받은 쪽지함 검색된 쪽지 수 조회 -->
	<select id="kdwSearchReceiveMsgCnt" parameterType="map" resultType="int">
	  SELECT COUNT(*)
	  FROM message
	  WHERE msg_receiver = #{msgReceiver}
	    AND msg_store_chk = 0
	    AND msg_delete_chk = 0
	    AND (
	        (#{type} = 'sender' AND msg_sender LIKE '%' || #{keyword} || '%')
	        OR
	        (#{type} = 'titleContent' AND (msg_title LIKE '%' || #{keyword} || '%' OR msg_content LIKE '%' || #{keyword} || '%'))
	        OR
	        (#{type} != 'sender' AND #{type} != 'titleContent' AND (
	            msg_sender LIKE '%' || #{keyword} || '%' OR
	            msg_title LIKE '%' || #{keyword} || '%' OR
	            msg_content LIKE '%' || #{keyword} || '%'
	        ))
	    )
	</select>
	<!-- ========== 보낸 쪽지함 검색기능 =========== -->
	<!-- 보낸 쪽지함 검색된 리스트 조회 -->
	<select id="kdwSearchSentMessages" parameterType="KdwMessage" resultType="KdwMessage">
	  <![CDATA[
	  SELECT *
	  FROM (
	      SELECT rownum rn, a.*
	      FROM (
	          SELECT *
	          FROM message
	          WHERE msg_sender = #{msgSender} 
	            AND msg_store_chk = 0
	            AND msg_delete_chk = 0
	            AND (
	                (#{type} = 'receiver' AND msg_receiver LIKE '%' || #{keyword} || '%')
	                OR
	                (#{type} = 'titleContent' AND (msg_title LIKE '%' || #{keyword} || '%' OR msg_content LIKE '%' || #{keyword} || '%'))
	                OR
	                (#{type} != 'receiver' AND #{type} != 'titleContent' AND (
	                    msg_receiver LIKE '%' || #{keyword} || '%' OR 
	                    msg_title LIKE '%' || #{keyword} || '%' OR 
	                    msg_content LIKE '%' || #{keyword} || '%'
	                ))
	            )
	      ) a
	      ORDER BY msg_no DESC
	  )
	  WHERE rn >= #{start} AND rn <= #{end}
	  ]]>
	</select>
	<!-- 보낸 쪽지함 검색된 쪽지 수 조회 -->
	<select id="kdwSearchSentMsgCnt" parameterType="map" resultType="int">
	  SELECT COUNT(*)
	  FROM message
	  WHERE msg_sender = #{msgSender}
	    AND msg_store_chk = 0
	    AND msg_delete_chk = 0
	    AND (
	        (#{type} = 'receiver' AND msg_receiver LIKE '%' || #{keyword} || '%')
	        OR
	        (#{type} = 'titleContent' AND (msg_title LIKE '%' || #{keyword} || '%' OR msg_content LIKE '%' || #{keyword} || '%'))
	        OR
	        (#{type} != 'receiver' AND #{type} != 'titleContent' AND (
	            msg_receiver LIKE '%' || #{keyword} || '%' OR
	            msg_title LIKE '%' || #{keyword} || '%' OR
	            msg_content LIKE '%' || #{keyword} || '%'
	        ))
	    )
	</select>
	<!-- ========== 쪽지 보관함 검색기능 =========== -->
	<!-- 쪽지 보관함 검색된 리스트 조회 -->
	<select id="kdwSearchStoredMessages" parameterType="KdwMessage" resultType="KdwMessage">
	  <![CDATA[
	  SELECT *
	  FROM (
	      SELECT rownum rn, a.*
	      FROM (
	          SELECT *
	          FROM message
	          WHERE (msg_receiver = #{storeboxUserNo} OR msg_sender = #{storeboxUserNo})
	            AND msg_store_chk = 1
	            AND msg_delete_chk = 0
	            AND (
	                (#{type} = 'sender' AND msg_sender LIKE '%' || #{keyword} || '%')
	                OR
	                (#{type} = 'receiver' AND msg_receiver LIKE '%' || #{keyword} || '%')
	                OR
	                (#{type} = 'titleContent' AND (msg_title LIKE '%' || #{keyword} || '%' OR msg_content LIKE '%' || #{keyword} || '%'))
	                OR
	                (#{type} != 'sender' AND #{type} != 'receiver' AND #{type} != 'titleContent' AND (
	                    msg_sender LIKE '%' || #{keyword} || '%' OR
	                    msg_receiver LIKE '%' || #{keyword} || '%' OR 
	                    msg_title LIKE '%' || #{keyword} || '%' OR 
	                    msg_content LIKE '%' || #{keyword} || '%'
	                ))
	            )
	      ) a
	      ORDER BY msg_no DESC
	  )
	  WHERE rn >= #{start} AND rn <= #{end}
	  ]]>
	</select>
	<!-- 쪽지 보관함 검색된 쪽지 수 조회 -->
	<select id="kdwSearchStoredMsgCnt" parameterType="map" resultType="int">
	  SELECT COUNT(*)
	  FROM message
	  WHERE (msg_receiver = #{storeboxUserNo} OR msg_sender = #{storeboxUserNo})
	    AND msg_store_chk = 1
	   	AND msg_delete_chk = 0
	    AND (
	    	(#{type} = 'sender' AND msg_sender LIKE '%' || #{keyword} || '%')
	        OR
	        (#{type} = 'receiver' AND msg_receiver LIKE '%' || #{keyword} || '%')
	        OR
	        (#{type} = 'titleContent' AND (msg_title LIKE '%' || #{keyword} || '%' OR msg_content LIKE '%' || #{keyword} || '%'))
	        OR
	        (#{type} != 'sender' AND #{type} != 'receiver' AND #{type} != 'titleContent' AND (
	            msg_sender LIKE '%' || #{keyword} || '%' OR
	            msg_receiver LIKE '%' || #{keyword} || '%' OR
	            msg_title LIKE '%' || #{keyword} || '%' OR
	            msg_content LIKE '%' || #{keyword} || '%'
	        ))
	    )
	    
	</select>
	<!-- ========== 휴지통 검색기능 =========== -->
	<!-- 휴지통 검색된 리스트 조회 -->
	<select id="kdwSearchTrashMessages" parameterType="KdwMessage" resultType="KdwMessage">
	  <![CDATA[
	  SELECT *
	  FROM (
	      SELECT rownum rn, a.*
	      FROM (
	          SELECT *
	          FROM message
	          WHERE (msg_receiver = #{trashboxUserNo} OR msg_sender = #{trashboxUserNo})
	            AND msg_delete_chk = 1
	            AND (
	                (#{type} = 'sender' AND msg_sender LIKE '%' || #{keyword} || '%')
	                OR
	                (#{type} = 'receiver' AND msg_receiver LIKE '%' || #{keyword} || '%')
	                OR
	                (#{type} = 'titleContent' AND (msg_title LIKE '%' || #{keyword} || '%' OR msg_content LIKE '%' || #{keyword} || '%'))
	                OR
	                (#{type} != 'sender' AND #{type} != 'receiver' AND #{type} != 'titleContent' AND (
	                    msg_sender LIKE '%' || #{keyword} || '%' OR
	                    msg_receiver LIKE '%' || #{keyword} || '%' OR 
	                    msg_title LIKE '%' || #{keyword} || '%' OR 
	                    msg_content LIKE '%' || #{keyword} || '%'
	                ))
	            )
	      ) a
	      ORDER BY msg_no DESC
	  )
	  WHERE rn >= #{start} AND rn <= #{end}
	  ]]>
	</select>
	<!-- 휴지통 검색된 쪽지 수 조회 -->
	<select id="kdwSearchTrashMsgCnt" parameterType="map" resultType="int">
	  SELECT COUNT(*)
	  FROM message
	  WHERE (msg_receiver = #{trashboxUserNo} OR msg_sender = #{trashboxUserNo})
	    AND msg_delete_chk = 1
	    AND (
	    	(#{type} = 'sender' AND msg_sender LIKE '%' || #{keyword} || '%')
	        OR
	        (#{type} = 'receiver' AND msg_receiver LIKE '%' || #{keyword} || '%')
	        OR
	        (#{type} = 'titleContent' AND (msg_title LIKE '%' || #{keyword} || '%' OR msg_content LIKE '%' || #{keyword} || '%'))
	        OR
	        (#{type} != 'sender' AND #{type} != 'receiver' AND #{type} != 'titleContent' AND (
	            msg_sender LIKE '%' || #{keyword} || '%' OR
	            msg_receiver LIKE '%' || #{keyword} || '%' OR
	            msg_title LIKE '%' || #{keyword} || '%' OR
	            msg_content LIKE '%' || #{keyword} || '%'
	        ))
	    )
	</select>
	
</mapper>