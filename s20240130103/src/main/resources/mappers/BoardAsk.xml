<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.blackberry.s20240130103.BoardAsk">
	<select id="sltotalBoardAskList" resultType="int">
		select count(*)
		from board_comm
		where CBOARD_DELETE_CHK = 0
		AND comm_big=300
		AND comm_mid=10
	</select>

	<select id="slBoardAskListAll" parameterType="LslBoardComm"
		resultType="LslBoardComm">
<![CDATA[
SELECT *
		from
			(SELECT rownum rn ,a.*
			from
				(SELECT bc.*, nvl(cnt,0) creply_cnt, u.user_name, u.user_nic
				FROM BOARD_COMM bc,
						(SELECT CBOARD_NO, count(*) cnt 
						FROM BOARD_COMM_REPLY 
						WHERE CREPLY_DELETE_CHK = 0
						GROUP BY CBOARD_NO) bcr,
						users u
				WHERE bc.CBOARD_NO =bcr.CBOARD_NO(+)
				AND comm_big=300
				AND comm_mid=10
				AND	bc.CBOARD_DELETE_CHK = 0
				AND bc.user_no = u.user_no
				order by cboard_date DESC) a)
		WHERE  rn >= #{start}
		 and		rn <=#{end}

]]>
	</select>

	<select id="sltotalBoardSearchAsk" resultType="int">
		SELECT count(*)
		FROM BOARD_COMM bc , USERS u
		WHERE bc.USER_NO = u.USER_NO
		AND
		bc.COMM_MID = 10
		AND bc.COMM_BIG = 300
		AND bc.CBOARD_DELETE_CHK = 0
		AND
		(CBOARD_TITLE LIKE '%' || #{keyword} || '%'
		OR CBOARD_CONTENT LIKE '%'
		|| #{keyword} || '%'
		OR USER_NIC LIKE '%' || #{keyword} || '%')
	</select>


	<select id="slboardAskSearch" parameterType="LslBoardComm"
		resultType="LslBoardComm">
		SELECT * FROM (
    SELECT rownum rn, a.*
    FROM (
        SELECT bc.*, u.user_nic, COUNT(bcr.CREPLY_NO) creply_cnt
        FROM BOARD_COMM bc
        JOIN users u ON bc.USER_NO = u.USER_NO
        LEFT JOIN BOARD_COMM_REPLY bcr ON bc.CBOARD_NO = bcr.CBOARD_NO AND bcr.CREPLY_DELETE_CHK = 0
        WHERE bc.COMM_MID = 10
        AND bc.COMM_BIG = 300
        AND bc.CBOARD_DELETE_CHK = 0
        AND (
            bc.CBOARD_TITLE LIKE '%' || #{keyword} || '%'
            OR bc.CBOARD_CONTENT LIKE '%' || #{keyword} || '%'
            OR u.USER_NIC LIKE '%' || #{keyword} || '%'
        )
        GROUP BY bc.CBOARD_NO, bc.CBOARD_TITLE, bc.CBOARD_CONTENT,
        bc.CBOARD_VIEWCNT, bc.CBOARD_DATE, bc.USER_NO, bc.CBOARD_DELETE_CHK,
        bc.COMM_BIG, bc.COMM_MID, bc.COMM_BIG2, bc.COMM_MID2,
        bc.COMM_UPDATE_DATE, u.USER_Nic
        ORDER BY bc.CBOARD_DATE DESC
    ) a
) WHERE rn BETWEEN #{start} AND #{end}
	</select>

	<select id="slboardAskContents" parameterType="int"
		resultType="LslBoardComm">
		SELECT bc.*, u.user_nic, u.user_profile
		FROM BOARD_COMM bc
		INNER JOIN USERS u
		ON bc.USER_NO = u.USER_NO
		WHERE bc.CBOARD_NO = #{cboard_no}
	</select>


	<insert id="slboardAskWriteInsert" parameterType="LslBoardComm"
		useGeneratedKeys="true" keyColumn="cboard_no" keyProperty="cboard_no">
		INSERT INTO
		BOARD_COMM(cboard_no,
		cboard_title,
		cboard_content,
		cboard_viewcnt,
		cboard_date,
		user_no,
		cboard_delete_chk,
		comm_big,
		comm_mid,
		comm_big2,
		comm_mid2,
		comm_update_date)
		VALUES (SEQ_BOARD_COMM.nextval,
		#{cboard_title},
		#{cboard_content}, 0 ,
		sysdate, #{user_no}, 0, 300,
		10,NULL, NULL,
		sysdate)
	</insert>


	<insert id="slSaveBoarAskdFile" parameterType="LslboardFile">
		INSERT INTO
		BOARD_COMM_FILE
		(cboard_no,
		cboard_file_name,
		cboard_file_user_name,
		cboard_file_cnt
		)
		VALUES(
		#{cboard_no},
		#{cboard_file_name},
		#{cboard_file_user_name},
		(SELECT
		NVL(MAX(cboard_file_cnt), 0) + 1
		FROM
		BOARD_COMM_FILE
		WHERE cboard_no = #{cboard_no})
		)
	</insert>

	<update id="slboardAskViewCnt" parameterType="LslBoardComm">
		update board_comm
		set CBOARD_VIEWCNT = CBOARD_VIEWCNT+1 where
		cboard_no=#{cboard_no}
	</update>


	<update id="sldeleteAskBoard" parameterType="LslBoardComm">
		update board_comm
		set CBOARD_DELETE_CHK = 1, COMM_UPDATE_DATE = sysdate
		where
		cboard_no =
		#{cboard_no}
	</update>

	<select id="slboardAskModify" parameterType="int"
		resultType="LslBoardComm">
		select bc.*
		from board_comm bc
		where bc.cboard_no = #{cboard_no}
	</select>

	<!-- 게시판 파일 정보 && 파일 상세 정보 표시 -->
	<select id="slboardAskFiles" resultType="LslboardFile">
		SELECT cboard_no, cboard_file_name, cboard_file_user_name, cboard_file_cnt
		FROM BOARD_COMM_FILE
		WHERE cboard_no = #{cboard_no}
	</select>


</mapper>