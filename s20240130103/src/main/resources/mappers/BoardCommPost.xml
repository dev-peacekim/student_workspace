<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.blackberry.s20240130103.BoardStudyMapper">
	<select id="ykmGetPostList" parameterType="YkmBoardComm" resultType="YkmBoardComm">	
		SELECT a.*
		FROM (SELECT ROWNUM rn , a.*
		FROM (SELECT B.CBOARD_NO, B.CBOARD_TITLE, B.CBOARD_VIEWCNT, B.CBOARD_DATE, B.COMM_BIG2 ,B.COMM_MID2, U.USER_ID, U.USER_NIC,
				       (SELECT COUNT(creply_no) FROM BOARD_COMM_REPLY WHERE CREPLY_DELETE_CHK = 0 AND CBOARD_NO = B.CBOARD_NO) AS reply_count
						FROM BOARD_COMM B
						JOIN USERS U ON U.USER_NO = B.USER_NO
						WHERE 
							B.COMM_BIG=200 
							AND B.COMM_MID = 20
							<if test="comm_mid2 != 0">
							AND B.COMM_MID2 = #{comm_mid2} 
							</if>
						ORDER BY B.CBOARD_DATE DESC) a) a
		WHERE a.rn BETWEEN #{start} AND #{end}
	</select>
	
	<select id="ykmGetPost" resultType="YkmBoardComm" parameterType="int">
		SELECT B.*, U.USER_ID, U.USER_NIC
		FROM BOARD_COMM B,USERS U
		WHERE B.CBOARD_NO = #{cboard_no}
		AND B.USER_NO = U.USER_NO
	</select>
	
	<insert id="ykmWritePost" parameterType="YkmBoardComm">
		INSERT INTO BOARD_COMM (CBOARD_NO,
								CBOARD_TITLE,
								CBOARD_CONTENT,
								CBOARD_VIEWCNT,
								CBOARD_DATE,
								USER_NO,
								CBOARD_DELETE_CHK,
								COMM_BIG,
								COMM_MID,
								COMM_BIG2,
								COMM_MID2,
								COMM_UPDATE_DATE)
		VALUES (SEQ_BOARD_COMM.NEXTVAL, #{cboard_title}, #{cboard_content}, 0, sysdate, #{user_no}, 0, 200, 20, 400, 10, sysdate)
	</insert>
	
	<update id="ykmUpdatePost" parameterType="YkmBoardComm">
		UPDATE BOARD_COMM
		SET CBOARD_TITLE = #{cboard_title}, CBOARD_CONTENT = #{cboard_content}, COMM_UPDATE_DATE = sysdate
		WHERE CBOARD_NO = #{cboard_no}
	</update>
	
	<update id="ykmDeletePost" parameterType="int">
		UPDATE BOARD_COMM
		SET CBOARD_DELETE_CHK = 1, COMM_UPDATE_DATE = SYSDATE
		WHERE CBOARD_NO = #{cboard_no}
	</update>
	
	<update id="ykmIncreseViewCount" parameterType="int">
		UPDATE BOARD_COMM
		SET CBOARD_VIEWCNT = CBOARD_VIEWCNT + 1
		WHERE CBOARD_NO = #{cboard_no}
	</update>
	
 	<update id="ykmUpdateRecruitment" parameterType="YkmBoardComm">
 		UPDATE BOARD_COMM
		SET COMM_MID2 = #{comm_mid2}
		WHERE CBOARD_NO = #{cboard_no}
 	</update>
 	
 	<select id="ykmGetSearchList" parameterType="YkmBoardComm" resultType="YkmBoardComm">
 		SELECT B.CBOARD_NO, B.CBOARD_TITLE, B.CBOARD_VIEWCNT, B.CBOARD_DATE, B.COMM_BIG2 ,B.COMM_MID2, U.USER_ID, U.USER_NIC,
		       (SELECT COUNT(creply_no) FROM BOARD_COMM_REPLY WHERE CREPLY_DELETE_CHK = 0 AND CBOARD_NO = B.CBOARD_NO) AS reply_count
 		FROM BOARD_COMM B, USERS U
 		WHERE B.COMM_BIG=200 AND B.COMM_MID = 20
 			AND B.USER_NO = U.USER_NO
 			<if test="comm_mid2 != 0">
			AND B.COMM_MID2 = #{comm_mid2} 
			</if>
 		<choose>
			<when test="type == 'TC'">
				AND (B.CBOARD_TITLE LIKE '%'||#{keyword}||'%' OR B.CBOARD_CONTENT LIKE '%'||#{keyword}||'%')
			</when>
			<when test="type == 'W'">
				AND U.USER_NIC = #{keyword}
			</when>
			<otherwise>
			</otherwise>
		</choose>
		ORDER BY B.CBOARD_DATE DESC
 	</select>

	<!-- TOTAL  -->
	<select id="ykmGetTotalCount" parameterType="YkmBoardComm" resultType="int">
		SELECT COUNT(*)
		FROM BOARD_COMM
		WHERE COMM_BIG = 200
	 	  AND COMM_MID = 20
	</select>
	
	<insert id="ykmSaveFileList" parameterType="java.util.List" 
				useGeneratedKeys="true" keyColumn="cboard_no" keyProperty="cboard_no">
		INSERT INTO BOARD_COMM_FILE (CBOARD_NO, CBOARD_FILE_NAME, CBOARD_FILE_USER_NAME, CBOARD_FILE_CNT)
		VALUES (
				SEQ_BOARD_COMM.NEXTVAL, 
				#{cboard_file_name}, 
				#{cboard_file_user_name}, 
				(SELECT NVL(MAX(CBOARD_NO), 0) + 1 FROM BOARD_COMM_FILE WHERE CBOARD_NO = #{cboard_no})
				)
	</insert>
</mapper>